<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Virtual Try-On Full</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;display:flex;flex-direction:column;align-items:center;padding:16px;gap:12px;background:#f3f4f6}
h1{font-size:18px;margin:6px}
#wrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:980px}
.panel{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
#preview, #result { width:320px; height:420px; background:#e9e9e9; border-radius:8px; display:flex;align-items:center;justify-content:center; overflow:hidden }
img{max-width:100%; max-height:100%}
.controls{display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
button{padding:10px 14px;border-radius:8px;background:#0b74de;color:#fff;border:none;cursor:pointer}
.small{padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #ddd;cursor:pointer}
label{cursor:pointer}
.thumbs{display:flex;gap:8px}
.thumbs img{width:60px;height:80px;object-fit:cover;border-radius:6px;border:2px solid transparent;cursor:pointer}
.thumbs img.selected{border-color:#0b74de}
#shopee{display:inline-block;padding:9px 14px;border-radius:8px;background:#ee4d2d;color:#fff;text-decoration:none;font-weight:700}
small{color:#666}
</style>
</head>
<body>
<h1>AI Virtual Try-On Full</h1>

<div id="wrap">
  <div class="panel">
    <div id="preview">Preview foto (upload dulu)</div>
    <div style="margin-top:8px" class="controls">
      <input id="fileInput" type="file" accept="image/*">
      <div class="row">
        <strong>Baju:</strong>
        <div class="thumbs">
          <img id="b1" src="baju1.png" class="selected" onclick="selectCloth('baju',1)">
          <img id="b2" src="baju2.png" onclick="selectCloth('baju',2)">
          <img id="b3" src="baju3.png" onclick="selectCloth('baju',3)">
        </div>
      </div>
      <div class="row">
        <strong>Celana:</strong>
        <div class="thumbs">
          <img id="c1" src="celana1.png" class="selected" onclick="selectCloth('celana',1)">
          <img id="c2" src="celana2.png" onclick="selectCloth('celana',2)">
          <img id="c3" src="celana3.png" onclick="selectCloth('celana',3)">
        </div>
      </div>
      <div class="row">
        <button id="generateBtn" type="button">Generate AI Try-On</button>
        <button id="downloadBtn" class="small" type="button" disabled>Download</button>
      </div>
      <small>Tips: gunakan foto full-body, pencahayaan terang â†’ hasil lebih rapi.</small>
    </div>
  </div>

  <div class="panel">
    <div id="result">Hasil akan muncul di sini</div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <a id="shopee" href="https://shopee.co.id/ovikids.official" target="_blank">Beli di Shopee</a>
    </div>
  </div>
</div>

<canvas id="maskCanvas" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
<script>
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const resultBox = document.getElementById('result');
const generateBtn = document.getElementById('generateBtn');
const downloadBtn = document.getElementById('downloadBtn');
const maskCanvas = document.getElementById('maskCanvas');

let uploadedFile = null;
let uploadedImg = null;
let selectedBaju = 1;
let selectedCelana = 1;

function selectCloth(type,n){
  if(type==='baju'){
    selectedBaju = n;
    ['b1','b2','b3'].forEach((id,i)=>document.getElementById(id).classList.toggle('selected', i===n-1));
  } else {
    selectedCelana = n;
    ['c1','c2','c3'].forEach((id,i)=>document.getElementById(id).classList.toggle('selected', i===n-1));
  }
}

fileInput.addEventListener('change', ev=>{
  const f = ev.target.files[0];
  if(!f) return;
  uploadedFile = f;
  const url = URL.createObjectURL(f);
  uploadedImg = new Image();
  uploadedImg.onload = ()=> {
    preview.innerHTML = '';
    preview.appendChild(uploadedImg);
    resultBox.innerHTML = 'Hasil akan muncul di sini';
    downloadBtn.disabled = true;
  };
  uploadedImg.src = url;
});

// Segmentasi tubuh untuk masking baju/celana
const seg = new SelfieSegmentation({modelSelection:1});
seg.onResults(r=>{
  const ctx = maskCanvas.getContext('2d');
  maskCanvas.width = uploadedImg.naturalWidth;
  maskCanvas.height = uploadedImg.naturalHeight;
  ctx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
  ctx.drawImage(r.segmentationMask,0,0,maskCanvas.width,maskCanvas.height);
});

async function generateMask(){
  return new Promise(async (resolve)=>{
    await seg.send({image:uploadedImg});
    // Dapatkan mask sebagai base64 PNG
    maskCanvas.toBlob(blob=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result.split(',')[1]);
      reader.readAsDataURL(blob);
    });
  });
}

// === OpenAI Image API Integration ===
async function generateTryOn(){
  if(!uploadedFile){ alert('Upload foto dulu'); return; }

  generateBtn.disabled = true;
  generateBtn.innerText = 'Processing...';

  try {
    // Base64 foto
    const base64Img = await new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result.split(',')[1]);
      reader.onerror = err=> reject(err);
      reader.readAsDataURL(uploadedFile);
    });

    // Base64 mask otomatis
    const maskBase64 = await generateMask();

    // Prompt realistis
    const bajuMap = {1:'baju merah waffle sleeveless',2:'baju biru polos',3:'baju kuning ceria'};
    const celanaMap = {1:'celana pendek putih',2:'celana jeans',3:'celana hitam polos'};
    const prompt = `Ganti pakaian anak di foto ini dengan ${bajuMap[selectedBaju]} dan ${celanaMap[selectedCelana]}. Full-body, mengikuti pose anak, pencahayaan natural, background tetap sama, realistis seperti foto studio.`;

    // Panggil API OpenAI Edits
    const resp = await fetch('https://api.openai.com/v1/images/edits', {
      method:'POST',
      headers:{
        'Authorization':'Bearer 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',
        'Content-Type':'application/json'
      },
      body: JSON.stringify({
        image: `data:image/png;base64,${base64Img}`,
        mask: `data:image/png;base64,${maskBase64}`,
        prompt: prompt,
        size: "512x768"
      })
    });

    const data = await resp.json();
    const imgUrl = data.data[0].url;

    // Tampilkan hasil
    resultBox.innerHTML = '';
    const resultImg = new Image();
    resultImg.src = imgUrl;
    resultImg.onload = ()=> resultBox.appendChild(resultImg);

    downloadBtn.disabled = false;
    downloadBtn.onclick = ()=> {
      const a = document.createElement('a');
      a.href = imgUrl;
      a.download = 'tryon_ai_full.png';
      a.click();
    };

  } catch(err){
    console.error(err);
    alert('Error: '+err.message);
  } finally {
    generateBtn.disabled = false;
    generateBtn.innerText = 'Generate AI Try-On';
  }
}

generateBtn.addEventListener('click', generateTryOn);
</script>
</body>
</html>
