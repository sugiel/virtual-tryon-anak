<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Try-On Foto (Baju + Celana)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;display:flex;flex-direction:column;align-items:center;padding:16px;gap:12px;background:#f3f4f6}
    h1{font-size:18px;margin:6px}
    #wrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:center;width:100%;max-width:980px}
    .panel{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    #preview, #result { width:320px; height:420px; background:#e9e9e9; border-radius:8px; display:flex;align-items:center;justify-content:center; overflow:hidden }
    img{max-width:100%; max-height:100%}
    .controls{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;align-items:center}
    button{padding:10px 14px;border-radius:8px;background:#0b74de;color:#fff;border:none;cursor:pointer}
    .small{padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #ddd;cursor:pointer}
    label{cursor:pointer}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:60px;height:80px;object-fit:cover;border-radius:6px;border:2px solid transparent;cursor:pointer}
    .thumbs img.selected{border-color:#0b74de}
    #shopee{display:inline-block;padding:9px 14px;border-radius:8px;background:#ee4d2d;color:#fff;text-decoration:none;font-weight:700}
    small{color:#666}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
</head>
<body>
  <h1>Virtual Try-On (Baju + Celana)</h1>

  <div id="wrap">
    <div class="panel">
      <div id="preview">Preview foto (upload dulu)</div>
      <div style="margin-top:8px" class="controls">
        <input id="fileInput" type="file" accept="image/*">

        <label>Pilih Baju:</label>
        <div class="row thumbs">
          <img id="b1" src="baju1.png" class="selected" onclick="selectBaju(1)">
          <img id="b2" src="baju2.png" onclick="selectBaju(2)">
          <img id="b3" src="baju3.png" onclick="selectBaju(3)">
        </div>

        <label>Pilih Celana:</label>
        <div class="row thumbs">
          <img id="c1" src="celana1.png" class="selected" onclick="selectCelana(1)">
          <img id="c2" src="celana2.png" onclick="selectCelana(2)">
          <img id="c3" src="celana3.png" onclick="selectCelana(3)">
        </div>

        <div class="row">
          <button id="generateBtn" type="button">Generate Try-On</button>
          <button id="downloadBtn" class="small" type="button" disabled>Download</button>
        </div>
        <small>Tips: gunakan foto full-body (anak berdiri), pencahayaan terang â†’ hasil lebih rapi.</small>
      </div>
    </div>

    <div class="panel">
      <div id="result">Hasil akan muncul di sini</div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <a id="shopee" href="https://shopee.co.id/ovikids.official" target="_blank">Beli di Shopee</a>
        <small>atau unduh lalu upload ke toko untuk belanja</small>
      </div>
    </div>
  </div>

  <canvas id="offscreen" style="display:none;"></canvas>

  <script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const resultBox = document.getElementById('result');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const offscreen = document.getElementById('offscreen');

    const bajuThumbs = [null, document.getElementById('b1'), document.getElementById('b2'), document.getElementById('b3')];
    const celanaThumbs = [null, document.getElementById('c1'), document.getElementById('c2'), document.getElementById('c3')];

    let uploadedImage = null;
    let selectedBaju = 1;
    let selectedCelana = 1;

    function selectBaju(n){
      selectedBaju = n;
      bajuThumbs.forEach((t,i)=>{ if(!t) return; t.classList.toggle('selected', i===n) });
    }
    function selectCelana(n){
      selectedCelana = n;
      celanaThumbs.forEach((t,i)=>{ if(!t) return; t.classList.toggle('selected', i===n) });
    }

    fileInput.addEventListener('change', (ev)=>{
      const f = ev.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.onload = () => {
        uploadedImage = img;
        preview.innerHTML = '';
        preview.appendChild(img);
        resultBox.innerHTML = 'Hasil akan muncul di sini';
        downloadBtn.disabled = true;
      };
      img.src = url;
    });

    let latestPose = null;
    let latestSegMask = null;

    const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}` });
    pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    pose.onResults((r)=>{ latestPose = r.poseLandmarks; });

    const seg = new SelfieSegmentation({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}` });
    seg.setOptions({ modelSelection: 1 });
    seg.onResults((r)=>{ latestSegMask = r.segmentationMask; });

    async function analyseImage(img){
      latestPose = null; latestSegMask = null;
      await pose.send({image: img});
      await seg.send({image: img});
      return { pose: latestPose, segMask: latestSegMask };
    }

    async function generateTryOn(){
      if(!uploadedImage){ alert('Silakan upload foto dulu'); return; }
      generateBtn.disabled = true; generateBtn.innerText = 'Processing...';

      try {
        await analyseImage(uploadedImage);
        const w = uploadedImage.naturalWidth;
        const h = uploadedImage.naturalHeight;
        offscreen.width = w;
        offscreen.height = h;
        const ctx = offscreen.getContext('2d');
        ctx.clearRect(0,0,w,h);
        ctx.drawImage(uploadedImage, 0, 0, w, h);

        // Gambar baju
        const bajuImg = new Image();
        bajuImg.src = `baju${selectedBaju}.png`;
        await new Promise(r => bajuImg.onload = r);

        let bx = w*0.2, by = h*0.25, bw = w*0.6, bh = h*0.45;
        if(latestPose && latestPose.length){
          const ls = latestPose[11], rs = latestPose[12], lh = latestPose[23], rh = latestPose[24];
          if(ls && rs && lh && rh){
            const shoulderW = Math.abs((rs.x - ls.x) * w);
            const torsoH = Math.abs((lh.y - ls.y) * h);
            const centerX = ((ls.x + rs.x) / 2) * w;
            const topY = (ls.y * h) - (torsoH * 0.15);
            bw = Math.max(shoulderW * 2.0, w*0.35);
            bh = Math.max(torsoH * 1.4, h*0.25);
            bx = centerX - bw/2;
            by = topY;
          }
        }
        ctx.drawImage(bajuImg, bx, by, bw, bh);

        // Gambar celana
        const celanaImg = new Image();
        celanaImg.src = `celana${selectedCelana}.png`;
        await new Promise(r => celanaImg.onload = r);

        let cx = w*0.3, cy = h*0.55, cw = w*0.4, ch = h*0.4;
        if(latestPose && latestPose.length){
          const lh = latestPose[23], rh = latestPose[24], lk = latestPose[25], rk = latestPose[26];
          if(lh && rh && lk && rk){
            const hipW = Math.abs((rh.x - lh.x) * w);
            const legH = Math.abs(((lk.y + rk.y)/2 - (lh.y + rh.y)/2) * h);
            const centerX = ((lh.x + rh.x) / 2) * w;
            const hipY = ((lh.y + rh.y) / 2) * h;
            cw = Math.max(hipW * 2.0, w*0.3);
            ch = Math.max(legH * 1.3, h*0.3);
            cx = centerX - cw/2;
            cy = hipY;
          }
        }
        ctx.drawImage(celanaImg, cx, cy, cw, ch);

        // Tampilkan hasil
        resultBox.innerHTML = '';
        const previewImg = new Image();
        previewImg.src = offscreen.toDataURL('image/png');
        previewImg.onload = () => resultBox.appendChild(previewImg);

        downloadBtn.disabled = false;
        downloadBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = offscreen.toDataURL('image/png');
          a.download = 'tryon_result.png';
          a.click();
        };
      } catch (err) {
        console.error(err);
        alert('Terjadi error: ' + err.message);
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerText = 'Generate Try-On';
      }
    }

    generateBtn.addEventListener('click', generateTryOn);
  </script>
</body>
</html>
