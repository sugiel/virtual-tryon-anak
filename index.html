<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual Try-On (Scale Sederhana)</title>
  <style>
    body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;padding:16px;background:#f9fafb}
    h1{font-size:20px;margin:10px}
    #wrap{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;max-width:1000px;width:100%}
    .panel{background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    #preview, #result {width:320px;height:420px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    img{max-width:100%;max-height:100%}
    .controls{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .thumbs img{width:60px;height:80px;object-fit:cover;border-radius:6px;border:2px solid transparent;cursor:pointer}
    .thumbs img.selected{border-color:#2563eb}
    button{padding:10px 16px;border:none;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
    .small{padding:8px 12px;background:#fff;border:1px solid #ddd;color:#333}
    #shopee{background:#ee4d2d;padding:10px 16px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700}
    small{color:#555}
  </style>

  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
</head>
<body>
  <h1>Virtual Try-On (Baju + Celana)</h1>

  <div id="wrap">
    <div class="panel">
      <div id="preview">Upload foto dulu</div>
      <div class="controls">
        <input id="fileInput" type="file" accept="image/*">

        <div class="row">
          <label>Baju:</label>
          <div class="thumbs">
            <img id="b1" src="baju1.png" class="selected" onclick="selectBaju(1)">
            <img id="b2" src="baju2.png" onclick="selectBaju(2)">
            <img id="b3" src="baju3.png" onclick="selectBaju(3)">
          </div>
        </div>

        <div class="row">
          <label>Celana:</label>
          <div class="thumbs">
            <img id="c1" src="celana1.png" class="selected" onclick="selectCelana(1)">
            <img id="c2" src="celana2.png" onclick="selectCelana(2)">
            <img id="c3" src="celana3.png" onclick="selectCelana(3)">
          </div>
        </div>

        <div class="row">
          <button id="generateBtn">Generate Try-On</button>
          <button id="downloadBtn" class="small" disabled>Download</button>
        </div>
        <small>Tips: gunakan foto full-body (anak berdiri), pencahayaan terang.</small>
      </div>
    </div>

    <div class="panel">
      <div id="result">Hasil akan muncul di sini</div>
      <div style="margin-top:12px">
        <a id="shopee" href="https://shopee.co.id/ovikids.official" target="_blank">Beli di Shopee</a>
      </div>
    </div>
  </div>

  <canvas id="offscreen" style="display:none;"></canvas>

  <script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const resultBox = document.getElementById('result');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const offscreen = document.getElementById('offscreen');

    let uploadedImage = null;
    let selectedBaju = 1;
    let selectedCelana = 1;

    const thumbsBaju = [null, document.getElementById('b1'), document.getElementById('b2'), document.getElementById('b3')];
    const thumbsCelana = [null, document.getElementById('c1'), document.getElementById('c2'), document.getElementById('c3')];

    function selectBaju(n){
      selectedBaju = n;
      thumbsBaju.forEach((t,i)=>{ if(!t) return; t.classList.toggle('selected', i===n) });
    }
    function selectCelana(n){
      selectedCelana = n;
      thumbsCelana.forEach((t,i)=>{ if(!t) return; t.classList.toggle('selected', i===n) });
    }

    fileInput.addEventListener('change', (ev)=>{
      const f = ev.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      const img = new Image();
      img.onload = () => {
        uploadedImage = img;
        preview.innerHTML = '';
        preview.appendChild(img);
        resultBox.innerHTML = 'Hasil akan muncul di sini';
        downloadBtn.disabled = true;
      };
      img.src = url;
    });

    // Pose detection
    let latestPose = null;
    const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}` });
    pose.setOptions({ modelComplexity: 0, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    pose.onResults((r)=>{ latestPose = r.poseLandmarks; });

    async function analyseImage(img){
      latestPose = null;
      await pose.send({image: img});
      return latestPose;
    }

    async function generateTryOn(){
      if(!uploadedImage){ alert("Upload foto dulu"); return; }
      generateBtn.disabled = true; generateBtn.innerText = "Processing...";

      try {
        const poseLandmarks = await analyseImage(uploadedImage);
        const w = uploadedImage.naturalWidth;
        const h = uploadedImage.naturalHeight;
        offscreen.width = w;
        offscreen.height = h;
        const ctx = offscreen.getContext('2d');
        ctx.clearRect(0,0,w,h);
        ctx.drawImage(uploadedImage, 0, 0, w, h);

        // Ambil tinggi badan
        let headY = h*0.2, ankleY = h*0.9;
        if(poseLandmarks){
          headY = poseLandmarks[0].y * h;
          ankleY = poseLandmarks[29].y * h;
        }
        const bodyHeight = ankleY - headY;

        // --- Baju ---
        const bajuImg = new Image();
        bajuImg.src = `baju${selectedBaju}.png`;
        await new Promise(r => bajuImg.onload = r);

        const bajuH = bodyHeight * 0.45;
        const bajuW = bajuH * (bajuImg.width / bajuImg.height);
        const bajuX = (w/2) - (bajuW/2);
        const bajuY = headY + bodyHeight*0.1;
        ctx.drawImage(bajuImg, bajuX, bajuY, bajuW, bajuH);

        // --- Celana ---
        const celanaImg = new Image();
        celanaImg.src = `celana${selectedCelana}.png`;
        await new Promise(r => celanaImg.onload = r);

        const celanaH = bodyHeight * 0.35;
        const celanaW = celanaH * (celanaImg.width / celanaImg.height);
        const celanaX = (w/2) - (celanaW/2);
        const celanaY = headY + bodyHeight*0.55;
        ctx.drawImage(celanaImg, celanaX, celanaY, celanaW, celanaH);

        // --- Output ---
        resultBox.innerHTML = '';
        const out = new Image();
        out.src = offscreen.toDataURL('image/png');
        out.onload = ()=> resultBox.appendChild(out);

        downloadBtn.disabled = false;
        downloadBtn.onclick = ()=>{
          const a = document.createElement('a');
          a.href = offscreen.toDataURL('image/png');
          a.download = "tryon_result.png";
          a.click();
        };

      } catch(err){
        console.error(err);
        alert("Error: "+err.message);
      } finally {
        generateBtn.disabled = false; generateBtn.innerText = "Generate Try-On";
      }
    }

    generateBtn.addEventListener('click', generateTryOn);
  </script>
</body>
</html>
